---
title: OAuth2
date: 2021-04-05T07:37:31+00:00
categories:
  - Java
summary: è¯¦ç»†ä»‹ç»OAuth2å¼€æ”¾æˆæƒåè®®ï¼ŒåŒ…æ‹¬æˆæƒç æ¨¡å¼å’Œå¯†ç å¼ä¸¤ç§æˆæƒæ–¹å¼ï¼Œä»¥åŠä½¿ç”¨Spring Cloud OAuth2æ„å»ºå¾®æœåŠ¡ç»Ÿä¸€è®¤è¯æœåŠ¡çš„å®Œæ•´å®ç°ã€‚
---

ä»Šå¤©æ˜¯æ¸…æ˜å‡æœŸæœ€åä¸€å¤©ï¼Œè·Ÿä»¥å¾€ä¸€æ ·ä¸‹èµ·äº†ç»†é›¨ã€‚å¤©æ°”è¶Šèˆ’é€‚ï¼Œäººçš„æ€ç»ªå°±å¥½åƒä¼šè¶Šä¹±ã€‚å¹´è½»äººå’Œé•¿è¾ˆçš„æƒ³æ³•æ€»ä¼šæœ‰å‡ºå…¥ï¼Œæ—©ä¸Šå®¶äººæå‡ºçš„è¯é¢˜è¢«æˆ‘è‰è‰ç»“æŸã€‚è™½è¡¨é¢ä¸Šç»“æŸäº†è¿™ä¸ªè¯é¢˜ï¼Œä½†å…¶å®å…³äºè¿™ä¸ªè¯é¢˜çš„è”æƒ³ä¸€ç›´è„‘æµ·è¦ç»•ã€‚è¿˜æ˜¯å†™ä¸€ç¯‡æŠ€æœ¯åšæ–‡å†·é™ä¸€ä¸‹å§ï¼Œç”Ÿæ´»ä¸Šäº‹æƒ…ä¸æå¤ªå¤šï¼Œæ¯•ç«Ÿè¿™é‡Œæ˜¯æŠ€æœ¯é¢‘é“ã€‚ ğŸ˜€

ä¸Šä¸ªæœˆæˆ‘ä»¬å°ç»„æ¥åˆ°ä¸€ä¸ªæ–°é¡¹ç›®ã€‚å…¶ä¸­ç™»å½•æ¨¡å—å…è®¸ç”¨æˆ·ä½¿ç”¨ç¬¬ä¸‰æ–¹è´¦æˆ·ç™»å½•ï¼Œä»¥ä¸‹ç®€ç§°â€œè´¦æˆ·ç³»ç»Ÿâ€ã€‚åæ¥è¿ç»´â€œè´¦æˆ·ç³»ç»Ÿâ€çš„å…¬å¸ç»™æˆ‘ä»¬å‘äº†ä¸€ä»½æŠ€æœ¯æ–‡æ¡£ï¼Œæˆ‘åœ¨æ–‡æ¡£çœ‹å®Œåå°±çŸ¥é“è¯¥â€œè´¦æˆ·ç³»ç»Ÿâ€ä½¿ç”¨äº†ç°åœ¨ä¸šç•Œæ¯”è¾ƒæµè¡Œçš„â€œOAuth2å¼€æ”¾æˆæƒåè®®â€æ¥å…è®¸â½¤æˆ·æˆæƒç¬¬ä¸‰â½…åº”â½¤è®¿é—®ä»–ä»¬å­˜å‚¨åœ¨æœåŠ¡æä¾›è€…é‡Œçš„ä¿¡æ¯ã€‚

æ°å¥½æœ€è¿‘ä¹Ÿåœ¨çœ‹OAuth2çš„èµ„æ–™ï¼Œäºæ˜¯é¡ºä¾¿ç»“åˆæ–°é¡¹ç›®ï¼ˆä»¥ä¸‹ç®€ç§°â€œè¡¨å•ç³»ç»Ÿâ€ï¼‰æ¥è°ˆè®ºä¸€ä¸‹OAuth2ã€‚é¦–å…ˆé€šè¿‡ç®€å›¾æ¥ä»‹ç»ä¸€ä¸‹ç³»ç»Ÿçš„ç»“æ„å’Œæ–¹æ¡ˆï¼Œå¦‚ä¸‹å›¾1ï¼š

<div class="wp-block-image">
  <figure class="aligncenter is-resized"><img decoding="async" loading="lazy" src="http://roliu.work/wp-content/uploads/2021/04/ç³»ç»Ÿç»“æ„ç®€å›¾.png" alt="" class="wp-image-807" width="391" height="297" /><figcaption>å›¾1 ç³»ç»Ÿç»“æ„ç®€å›¾</figcaption></figure>
</div>

ä¸Šå›¾ä¸­çœç•¥äº†æ•°æ®åº“å’Œå…¶ä»–ç»„ä»¶ï¼Œå®ç°OAuth2åè®®çš„ä»£ç éƒ½å·²ç»åœ¨è´¦æˆ·ç³»ç»Ÿï¼ˆèµ„æºæœåŠ¡å™¨å’Œè®¤è¯æœåŠ¡å™¨ï¼‰å®Œæˆã€‚æˆ‘ä»¬å¼€å‘çš„è¡¨å•ç³»ç»Ÿæä¾›å¿…è¦çš„å‚æ•°ï¼ˆclient_id, secret&#8230;ï¼‰å³å¯è·å–è´¦æˆ·ç³»ç»Ÿè¿”å›çš„æˆæƒç ï¼Œå†ç”¨æˆæƒç æ¢å–tokenï¼Œç”¨tokenæ¢å–ç”¨æˆ·ä¿¡æ¯å¹¶ä¿å­˜ï¼Œæœ€åè¡¨å•ç³»ç»Ÿç»™ç”¨æˆ·åˆ›å»ºsessionã€‚è¿™æ ·å°±å®Œæˆäº†â€˜ç”¨æˆ·æˆæƒâ€œè¡¨å•ç³»ç»Ÿâ€è®¿é—®ä»–ä»¬å‚¨å­˜åœ¨è´¦æˆ·ç³»ç»Ÿé‡Œçš„ä¿¡æ¯â€™ç™»å½•çš„æµç¨‹ã€‚ç®€å•æµç¨‹å›¾å¦‚ä¸‹å›¾2:

<div class="wp-block-image">
  <figure class="aligncenter is-resized"><img decoding="async" loading="lazy" src="http://roliu.work/wp-content/uploads/2021/04/äº§å­¦ç ”ç¬¬ä¸‰æ–¹ç™»é™†æµç¨‹å›¾-1024x294.png" alt="" class="wp-image-810" width="512" height="147" /><figcaption>å›¾2 ç™»å½•æµç¨‹</figcaption></figure>
</div>

OAuth2å¸¸ç”¨çš„ä¸¤ç§é¢å‘tokenæˆæƒæ–¹å¼ï¼š

  1. æˆæƒç (authorization-code)
  2. å¯†ç å¼(password)

ä¸Šè¿°çš„è¡¨å•ç³»ç»Ÿç™»å½•ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æˆæƒç æ¨¡å¼ï¼Œä¹Ÿæ˜¯OAuth2åè®®é‡Œæœ€å¤æ‚çš„ä¸€ç§æ¨¡å¼ï¼Œæˆæƒç æ¨¡å¼ä½¿â½¤åˆ°äº†å›è°ƒåœ°å€ï¼Œå¾®åšã€å¾®ä¿¡ã€QQç­‰ç¬¬ä¸‰â½…ç™»å½•å°±æ˜¯è¿™ç§æ¨¡å¼ã€‚

ä¸‹é¢ç¬”è€…ä¼šç»“åˆä»£ç æ¢³ç†å¸¸ç”¨æ–¹å¼ä¸­æ¯”è¾ƒç®€å•çš„å¯†ç å¼ã€‚ä»£ç ä½¿ç”¨Spring Cloud OAuth2æ„å»ºå¾®æœåŠ¡ç»Ÿâ¼€è®¤è¯æœåŠ¡ã€‚

Spring Cloud OAuth2 æ˜¯ Spring Cloud ä½“ç³»å¯¹OAuth2åè®®çš„å®ç°ï¼Œå¯ä»¥â½¤æ¥åšå¤šä¸ªå¾®æœåŠ¡çš„ç»Ÿâ¼€è®¤è¯ï¼ˆéªŒè¯èº«ä»½åˆæ³•æ€§ï¼‰æˆæƒï¼ˆéªŒè¯æƒé™ï¼‰ã€‚é€šè¿‡å‘OAuth2æœåŠ¡ï¼ˆç»Ÿâ¼€è®¤è¯æˆæƒæœåŠ¡ï¼‰å‘é€æŸä¸ªç±»å‹çš„grant\_typeè¿›â¾é›†ä¸­è®¤è¯å’Œæˆæƒï¼Œä»â½½è·å¾—access\_tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰ï¼Œâ½½è¿™ä¸ªtokenæ˜¯å—å…¶ä»–å¾®æœåŠ¡ä¿¡ä»»çš„ã€‚ç®€å•æµç¨‹å¦‚ä¸‹å›¾3:

<div class="wp-block-image">
  <figure class="aligncenter is-resized"><img decoding="async" loading="lazy" src="http://roliu.work/wp-content/uploads/2021/04/Spring-Cloud-OAuth2æµç¨‹-1024x498.png" alt="" class="wp-image-811" width="512" height="249" /><figcaption>å›¾3 å¾®æœåŠ¡ç»Ÿä¸€è®¤è¯ç®€å•æµç¨‹</figcaption></figure>
</div>

<div id="ez-toc-container" class="ez-toc-v2_0_56_1 counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction">
  <div class="ez-toc-title-container">
    <p class="ez-toc-title " >
      ç›®å½•
    </p>
    
    <span class="ez-toc-title-toggle"><a href="#" class="ez-toc-pull-right ez-toc-btn ez-toc-btn-xs ez-toc-btn-default ez-toc-toggle" aria-label="Toggle Table of Content" role="button"><label for="item-6896f659db738" ><span class=""><span style="display:none;">Toggle</span><span class="ez-toc-icon-toggle-span"><svg style="fill: #999;color:#999" xmlns="http://www.w3.org/2000/svg" class="list-377408" width="20px" height="20px" viewBox="0 0 24 24" fill="none"><path d="M6 6H4v2h2V6zm14 0H8v2h12V6zM4 11h2v2H4v-2zm16 0H8v2h12v-2zM4 16h2v2H4v-2zm16 0H8v2h12v-2z" fill="currentColor"></path></svg><svg style="fill: #999;color:#999" class="arrow-unsorted-368013" xmlns="http://www.w3.org/2000/svg" width="10px" height="10px" viewBox="0 0 24 24" version="1.2" baseProfile="tiny"><path d="M18.2 9.3l-6.2-6.3-6.2 6.3c-.2.2-.3.4-.3.7s.1.5.3.7c.2.2.4.3.7.3h11c.3 0 .5-.1.7-.3.2-.2.3-.5.3-.7s-.1-.5-.3-.7zM5.8 14.7l6.2 6.3 6.2-6.3c.2-.2.3-.5.3-.7s-.1-.5-.3-.7c-.2-.2-.4-.3-.7-.3h-11c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7s.1.5.3.7z"/></svg></span></span></label><input aria-label="Toggle" aria-label="item-6896f659db738"  type="checkbox" id="item-6896f659db738" /></a></span>
  </div><nav>
  
  <ul class='ez-toc-list ez-toc-list-level-1 ' >
    <li class='ez-toc-page-1 ez-toc-heading-level-3'>
      <a class="ez-toc-link ez-toc-heading-1" href="http://43.133.160.241/?p=805/#%E6%90%AD%E5%BB%BA%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88Authorization_Server%EF%BC%89" title="æ­å»ºè®¤è¯æœåŠ¡å™¨ï¼ˆAuthorization Serverï¼‰">æ­å»ºè®¤è¯æœåŠ¡å™¨ï¼ˆAuthorization Serverï¼‰</a><ul class='ez-toc-list-level-4'>
        <li class='ez-toc-heading-level-4'>
          <a class="ez-toc-link ez-toc-heading-2" href="http://43.133.160.241/?p=805/#%E6%96%B0%E5%BB%BA%E9%A1%B9%E2%BD%ACrobin-cloud-oauth-server-9999%EF%BC%8Cpomxml" title="æ–°å»ºé¡¹â½¬robin-cloud-oauth-server-9999ï¼Œpom.xml:">æ–°å»ºé¡¹â½¬robin-cloud-oauth-server-9999ï¼Œpom.xml:</a>
        </li>
        <li class='ez-toc-page-1 ez-toc-heading-level-4'>
          <a class="ez-toc-link ez-toc-heading-3" href="http://43.133.160.241/?p=805/#%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E7%B1%BB" title="è®¤è¯æœåŠ¡å™¨å®‰å…¨é…ç½®ç±»">è®¤è¯æœåŠ¡å™¨å®‰å…¨é…ç½®ç±»</a>
        </li>
      </ul>
    </li>
    
    <li class='ez-toc-page-1 ez-toc-heading-level-3'>
      <a class="ez-toc-link ez-toc-heading-4" href="http://43.133.160.241/?p=805/#%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88Resource_Server%EF%BC%89" title="èµ„æºæœåŠ¡å™¨ï¼ˆResource Serverï¼‰">èµ„æºæœåŠ¡å™¨ï¼ˆResource Serverï¼‰</a><ul class='ez-toc-list-level-4'>
        <li class='ez-toc-heading-level-4'>
          <a class="ez-toc-link ez-toc-heading-5" href="http://43.133.160.241/?p=805/#%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%B1%BB" title="èµ„æºæœåŠ¡é…ç½®ç±»">èµ„æºæœåŠ¡é…ç½®ç±»</a>
        </li>
      </ul>
    </li>
  </ul></nav>
</div>

### <span class="ez-toc-section" id="%E6%90%AD%E5%BB%BA%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88Authorization_Server%EF%BC%89"></span>**æ­å»ºè®¤è¯æœåŠ¡å™¨ï¼ˆAuthorization Serverï¼‰**<span class="ez-toc-section-end"></span> {.wp-block-heading}

è®¤è¯æœåŠ¡å™¨ï¼ˆAuthorization Serverï¼‰ï¼Œè´Ÿè´£é¢å‘tokenã€‚æ³¨æ„ï¼šè¿è¡Œæ­¤æœåŠ¡å‰éœ€è¦å…ˆè¿è¡ŒEurekaæœåŠ¡ã€‚

#### <span class="ez-toc-section" id="%E6%96%B0%E5%BB%BA%E9%A1%B9%E2%BD%ACrobin-cloud-oauth-server-9999%EF%BC%8Cpomxml"></span>**æ–°å»ºé¡¹â½¬robin-cloud-oauth-server-9999ï¼Œpom.xml:**<span class="ez-toc-section-end"></span> {.wp-block-heading}

<pre class="wp-block-preformatted">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;project xmlns="http://maven.apache.org/POM/4.0.0"<br />         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;<br />    &lt;parent&gt;<br />        &lt;artifactId&gt;robin-parent&lt;/artifactId&gt;<br />        &lt;groupId&gt;com.robin&lt;/groupId&gt;<br />        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;<br />    &lt;/parent&gt;<br />    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br /><br />    &lt;groupId&gt;com.robin&lt;/groupId&gt;<br />    &lt;artifactId&gt;robin-cloud-oauth-server-9999&lt;/artifactId&gt;<br /><br /><br />    &lt;dependencies&gt;<br />        &lt;!--å¯¼â¼ŠEureka Clientä¾èµ–--&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br />            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br />        &lt;/dependency&gt;<br />        &lt;!--å¯¼â¼Šspring cloud oauth2ä¾èµ–--&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br />            &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;<br />            &lt;exclusions&gt;<br />                &lt;exclusion&gt;<br />                    &lt;groupId&gt;org.springframework.security.oauth.boot&lt;/groupId&gt;<br />                    &lt;artifactId&gt;spring-security-oauth2-<br />                        autoconfigure&lt;/artifactId&gt;<br />                &lt;/exclusion&gt;<br />            &lt;/exclusions&gt;<br />        &lt;/dependency&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;org.springframework.security.oauth.boot&lt;/groupId&gt;<br />            &lt;artifactId&gt;spring-security-oauth2-autoconfigure&lt;/artifactId&gt;<br />            &lt;version&gt;2.1.11.RELEASE&lt;/version&gt;<br />        &lt;/dependency&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt;<br />            &lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt;<br />            &lt;version&gt;2.3.4.RELEASE&lt;/version&gt;<br />        &lt;/dependency&gt;<br />    &lt;/dependencies&gt;<br /><br />&lt;/project&gt;</pre>

**application.yml**

<pre class="wp-block-preformatted">server:<br />  port: 9999<br />spring:<br />  application:<br />    name: robin-cloud-oauth-server<br />eureka:<br />  client:<br />    service-url:<br />      defaultZone: http://robincloudeurekaservera:8761/eureka/,http://robincloudeurekaserverb:8762/eureka/ <em>#æŠŠeurekaé›†ç¾¤ä¸­çš„æ‰€æœ‰urléƒ½å¡«å†™äº†è¿›æ¥ï¼Œä¹Ÿå¯ä»¥åªå†™â¼€å°ï¼Œå› ä¸ºå„ä¸ªeureka serverå¯ä»¥åŒæ­¥æ³¨å†Œè¡¨<br />  </em>instance:<br />    <em>#ä½¿â½¤ipæ³¨å†Œï¼Œå¦åˆ™ä¼šä½¿â½¤ä¸»æœºåæ³¨å†Œ<br />    </em>prefer-ip-address: true<br />    instance-id: ${spring.cloud.client.ipaddress}:${spring.application.name}:${server.port}:@project.version@</pre>

**è®¤è¯æœåŠ¡å™¨é…ç½®ç±»:**

<pre class="wp-block-preformatted">package com.robin.config;<br /><br />import org.springframework.beans.factory.annotation.Autowired;<br />import org.springframework.context.annotation.Configuration;<br />import org.springframework.http.HttpMethod;<br />import org.springframework.security.authentication.AuthenticationManager;<br />import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;<br />import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;<br />import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;<br />import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;<br />import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;<br />import org.springframework.security.oauth2.provider.token.AuthorizationServerTokenServices;<br />import org.springframework.security.oauth2.provider.token.DefaultTokenServices;<br />import org.springframework.security.oauth2.provider.token.TokenStore;<br />import org.springframework.security.oauth2.provider.token.store.InMemoryTokenStore;<br /><br /><em>/**<br /> * </em><strong><em>@author </em></strong><em>Robin<br /> * </em><strong><em>@date </em></strong><em>2021/4/5<br /> *<br /> * å½“å‰ç±»ä¸ºOauth2 serverçš„é…ç½®ç±»ï¼ˆéœ€è¦ç»§æ‰¿ç‰¹å®šçš„â½—ç±»<br /> * AuthorizationServerConfigurerAdapterï¼‰<br /> */<br /></em>@Configuration<br />@EnableAuthorizationServer // å¼€å¯è®¤è¯æœåŠ¡å™¨åŠŸèƒ½<br />public class OauthServerConfiger extends AuthorizationServerConfigurerAdapter {<br /><br />    @Autowired<br />    AuthenticationManager authenticationManager;<br /><br />    <em>/**<br />     * è®¤è¯æœåŠ¡å™¨æœ€ç»ˆæ˜¯ä»¥apiæ¥â¼çš„â½…å¼å¯¹å¤–æä¾›æœåŠ¡ï¼ˆæ ¡éªŒåˆæ³•æ€§å¹¶â½£æˆä»¤ç‰Œã€æ ¡éªŒä»¤ç‰Œç­‰ï¼‰<br />     * é‚£ä¹ˆï¼Œä»¥apiæ¥â¼â½…å¼å¯¹å¤–çš„è¯ï¼Œå°±æ¶‰åŠåˆ°æ¥â¼çš„è®¿é—®æƒé™ï¼Œéœ€è¦åœ¨è¿™â¾¥è¿›â¾å¿…è¦çš„é…ç½®<br />     *<br />     * â½¤æ¥é…ç½®tokenç«¯ç‚¹çš„å®‰å…¨çº¦æŸ<br />     *<br />     * </em><strong><em>@param </em></strong><em>security<br />     * </em><strong><em>@throws </em></strong><em>Exception<br />     */<br />    </em>@Override<br />    public void configure(AuthorizationServerSecurityConfigurer security) throws Exception {<br />        super.configure(security);<br />        security.allowFormAuthenticationForClients() // å…è®¸å®¢æˆ·ç«¯è¡¨å•éªŒè¯<br />                .tokenKeyAccess("permitAll()") // å¼€å¯ç«¯â¼/oauth/token_keyçš„è®¿é—®æƒé™<br />                .checkTokenAccess("permitAll()"); // å¼€å¯ç«¯â¼/oauth/check_tokençš„è®¿é—®æƒé™<br />    }<br /><br />    <em>/**<br />     * å®¢æˆ·ç«¯è¯¦æƒ…é…ç½®ï¼Œå¦‚client_idï¼Œsecret<br />     * â½¤æ¥é…ç½®å®¢æˆ·ç«¯è¯¦æƒ…æœåŠ¡ï¼ˆClientDetailsServiceï¼‰ï¼Œå®¢æˆ·ç«¯è¯¦æƒ…ä¿¡æ¯åœ¨è¿™â¾¥è¿›â¾åˆå§‹åŒ–<br />     * å®¢æˆ·ç«¯è¯¦æƒ…ä¿¡æ¯å†™æ­»åœ¨è¿™é‡Œæˆ–è€…æ˜¯é€šè¿‡æ•°æ®åº“æ¥å­˜å‚¨è°ƒå–è¯¦æƒ…ä¿¡æ¯<br />     *<br />     * </em><strong><em>@param </em></strong><em>clients<br />     * </em><strong><em>@throws </em></strong><em>Exception<br />     */<br />    </em>@Override<br />    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {<br />        super.configure(clients);<br />        clients.inMemory() // ä¿¡æ¯å‚¨å­˜çš„åœ°æ–¹ï¼Œå†…å­˜/æ•°æ®åº“<br />                .withClient("client_robin") // // æ·»åŠ â¼€ä¸ªclienté…ç½®,æŒ‡å®šå…¶client_id<br />                .secret("123") // æŒ‡å®šå®¢æˆ·ç«¯çš„å¯†ç /å®‰å…¨ç <br />                .resourceIds("autodeliver") // æŒ‡å®šå®¢æˆ·ç«¯æ‰€èƒ½è®¿é—®èµ„æºidæ¸…å•ï¼Œæ­¤å¤„çš„èµ„æºidä¸å…·ä½“çš„èµ„æºæœåŠ¡å™¨ä¸Šçš„é…ç½®â¼€æ ·<br />                .authorizedGrantTypes("password","refresh_token") // è®¤è¯ç±»å‹/ä»¤ç‰Œé¢å‘æ¨¡å¼ï¼Œå¯ä»¥é…ç½®å¤šä¸ªï¼Œä½†æ˜¯ä¸â¼€å®šéƒ½â½¤ï¼Œå…·ä½“ä½¿â½¤å“ªç§â½…å¼é¢å‘tokenï¼Œéœ€è¦å®¢æˆ·ç«¯è°ƒâ½¤çš„æ—¶å€™ä¼ é€’å‚æ•°æŒ‡å®š<br />                .scopes("all"); // å®¢æˆ·ç«¯çš„æƒé™èŒƒå›´<br />    }<br /><br />    <em>/**<br />     * è¿™â¾¥é…ç½®tokenä»¤ç‰Œç®¡ç†ç›¸å…³<br />     * tokenæ­¤æ—¶å°±æ˜¯â¼€ä¸ªå­—ä¸²ï¼Œå½“ä¸‹çš„tokenéœ€è¦åœ¨æœåŠ¡å™¨ç«¯å­˜å‚¨<br />     *<br />     * </em><strong><em>@param </em></strong><em>endpoints<br />     * </em><strong><em>@throws </em></strong><em>Exception<br />     */<br />    </em>@Override<br />    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {<br />        super.configure(endpoints);<br />        endpoints.tokenStore(tokenStore()) // æŒ‡å®štokençš„å­˜å‚¨æ–¹æ³•<br />                    .tokenServices(authorizationServerTokenServices())<br />                    .authenticationManager(authenticationManager) // æŒ‡å®šè®¤è¯ç®¡ç†å™¨<br />                    .allowedTokenEndpointRequestMethods(HttpMethod.<em>GET</em>, HttpMethod.<em>POST</em>);<br />    }<br /><br />    <em>/**<br />     *<br />     * è¯¥â½…æ³•â½¤äºåˆ›å»ºtokenStoreå¯¹è±¡<br />     * tokenä»¥ä»€ä¹ˆå½¢å¼å­˜å‚¨ï¼Œ è¿™é‡Œæ˜¯å­˜åœ¨å†…å­˜<br />     *<br />     * </em><strong><em>@return<br />     </em></strong><em>*/<br />    </em>public TokenStore tokenStore() {<br />        return new InMemoryTokenStore();<br />    }<br /><br />    public AuthorizationServerTokenServices authorizationServerTokenServices() {<br />        // ä½¿â½¤é»˜è®¤å®ç°<br />        DefaultTokenServices defaultTokenServices = new DefaultTokenServices();<br />        defaultTokenServices.setSupportRefreshToken(true); // æ˜¯å¦å¼€å¯tokenåˆ·æ–°<br />        defaultTokenServices.setTokenStore(tokenStore());<br />        // è®¾ç½®tokenæœ‰æ•ˆæ—¶é—´ï¼ˆâ¼€èˆ¬è®¾ç½®ä¸º2ä¸ªâ¼©æ—¶ï¼‰<br />        // è¿™é‡Œè®¾ç½®äº†20ç§’<br />        defaultTokenServices.setAccessTokenValiditySeconds(20); // access_tokenå°±æ˜¯æˆ‘ä»¬è¯·æ±‚èµ„æºéœ€è¦æºå¸¦çš„ä»¤ç‰Œ<br />        // è®¾ç½®åˆ·æ–°tokençš„æœ‰æ•ˆæ—¶é—´<br />        defaultTokenServices.setRefreshTokenValiditySeconds(259200); // 3å¤©<br />        return defaultTokenServices;<br />    }<br />}<br /></pre>

å…³äºTokenStore:

  * InMemoryTokenStore
      * é»˜è®¤é‡‡â½¤ï¼Œå®ƒå¯ä»¥å®Œç¾çš„â¼¯ä½œåœ¨å•æœåŠ¡å™¨ä¸Šï¼ˆå³è®¿é—®å¹¶å‘é‡ å‹â¼’ä¸â¼¤çš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸”å®ƒåœ¨å¤±è´¥çš„æ—¶å€™ä¸ä¼šè¿›â¾å¤‡ä»½ï¼‰ï¼Œâ¼¤å¤šæ•°çš„é¡¹â½¬éƒ½å¯ä»¥ä½¿â½¤è¿™ä¸ªç‰ˆæœ¬çš„å®ç°æ¥è¿›â¾å°è¯•ï¼Œä½ å¯ä»¥åœ¨å¼€å‘çš„æ—¶å€™ä½¿â½¤å®ƒæ¥è¿›â¾ç®¡ç†ï¼Œå› ä¸ºä¸ä¼šè¢«ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œæ‰€ä»¥æ›´æ˜“äºè°ƒè¯•ã€‚
  * JdbcTokenStore
      * è¿™æ˜¯â¼€ä¸ªåŸºäºJDBCçš„å®ç°ç‰ˆæœ¬ï¼Œä»¤ç‰Œä¼šè¢«ä¿å­˜è¿›å…³ç³»å‹æ•°æ®åº“ã€‚ä½¿â½¤è¿™ä¸ªç‰ˆæœ¬çš„å®ç°æ—¶ï¼Œ ä½ å¯ä»¥åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¹‹é—´å…±äº«ä»¤ç‰Œä¿¡æ¯ï¼Œä½¿â½¤è¿™ä¸ªç‰ˆæœ¬çš„æ—¶å€™è¯·æ³¨æ„æŠŠ&#8221;spring-jdbc&#8221;è¿™ä¸ªä¾èµ–åŠ â¼Šåˆ°ä½ çš„ classpathå½“ä¸­ã€‚
  * JwtTokenStore
      * è¿™ä¸ªç‰ˆæœ¬çš„å…¨ç§°æ˜¯ JSON Web Tokenï¼ˆJWTï¼‰ï¼Œå®ƒå¯ä»¥æŠŠä»¤ç‰Œç›¸å…³çš„æ•°æ®è¿›â¾ç¼–ç ï¼ˆå› æ­¤å¯¹äºåç«¯æœåŠ¡æ¥è¯´ï¼Œå®ƒä¸éœ€è¦è¿›â¾å­˜å‚¨ï¼Œè¿™å°†æ˜¯â¼€ä¸ªé‡â¼¤ä¼˜åŠ¿ï¼‰ï¼Œç¼ºç‚¹å°±æ˜¯è¿™ä¸ªä»¤ç‰Œå â½¤çš„ç©ºé—´ä¼šâ½è¾ƒâ¼¤ï¼Œå¦‚æœä½ åŠ â¼Šäº†â½è¾ƒå¤šâ½¤æˆ·å‡­è¯ä¿¡æ¯ã€‚

#### <span class="ez-toc-section" id="%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E7%B1%BB"></span>**è®¤è¯æœåŠ¡å™¨å®‰å…¨é…ç½®ç±»**<span class="ez-toc-section-end"></span> {.wp-block-heading}

<pre class="wp-block-preformatted">package com.robin.config;<br /><br />import org.springframework.beans.factory.annotation.Autowired;<br />import org.springframework.context.annotation.Bean;<br />import org.springframework.security.authentication.AuthenticationManager;<br />import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;<br />import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br />import org.springframework.security.core.userdetails.User;<br />import org.springframework.security.core.userdetails.UserDetails;<br />import org.springframework.security.crypto.password.NoOpPasswordEncoder;<br />import org.springframework.security.crypto.password.PasswordEncoder;<br /><br />import java.util.ArrayList;<br /><br /><em>/**<br /> * è¯¥é…ç½®ç±»ï¼Œä¸»è¦å¤„ç†â½¤æˆ·åå’Œå¯†ç çš„æ ¡éªŒç­‰äº‹å®œ<br /> *<br /> * </em><strong><em>@author </em></strong><em>Robin<br /> * </em><strong><em>@date </em></strong><em>2021/4/5<br /> */<br /></em>public class SecurityConfiger extends WebSecurityConfigurerAdapter {<br /><br />    <em>/**<br />     * æ³¨å†Œè®¤è¯ç®¡ç†å™¨å¯¹è±¡åˆ°å®¹å™¨<br />     */<br />    </em>@Bean<br />    @Override<br />    public AuthenticationManager authenticationManagerBean() throws Exception {<br />        return super.authenticationManagerBean();<br />    }<br /><br />    <em>/**<br />     * å¯†ç ç¼–ç å¯¹è±¡ï¼ˆå¯†ç ä¸è¿›â¾åŠ å¯†å¤„ç†ï¼‰<br />     * </em><strong><em>@return<br />     </em></strong><em>*/<br />    </em>@Bean<br />    public PasswordEncoder passwordEncoder() {<br />        return NoOpPasswordEncoder.<em>getInstance</em>();<br />    }<br /><br />    @Autowired<br />    private PasswordEncoder passwordEncoder;<br /><br />    <em>/**<br />     * å¤„ç†â½¤æˆ·åå’Œå¯†ç éªŒè¯äº‹å®œ<br />     * 1ï¼‰å®¢æˆ·ç«¯ä¼ é€’usernameå’Œpasswordå‚æ•°åˆ°è®¤è¯æœåŠ¡å™¨<br />     * 2ï¼‰â¼€èˆ¬æ¥è¯´ï¼Œusernameå’Œpasswordä¼šå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„â½¤æˆ·è¡¨ä¸­<br />     * 3ï¼‰æ ¹æ®â½¤æˆ·è¡¨ä¸­æ•°æ®ï¼ŒéªŒè¯å½“å‰ä¼ é€’è¿‡æ¥çš„â½¤æˆ·ä¿¡æ¯çš„åˆæ³•æ€§<br />     */<br />    </em>@Override<br />    protected void configure(AuthenticationManagerBuilder auth) throws Exception {<br />        // åœ¨è¿™ä¸ªâ½…æ³•ä¸­å°±å¯ä»¥å»å…³è”æ•°æ®åº“äº†ï¼Œå½“å‰æˆ‘ä»¬å…ˆæŠŠâ½¤æˆ·ä¿¡æ¯é…ç½®åœ¨å†…å­˜ä¸­<br />        // å®ä¾‹åŒ–â¼€ä¸ªâ½¤æˆ·å¯¹è±¡(ç›¸å½“äºæ•°æ®è¡¨ä¸­çš„â¼€æ¡â½¤æˆ·è®°å½•)<br />        UserDetails user = new User("admin","123456",new ArrayList&lt;&gt;());<br />        auth.inMemoryAuthentication()<br />                .withUser(user)<br />                .passwordEncoder(passwordEncoder);<br />    }<br />}<br /></pre>

### <span class="ez-toc-section" id="%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88Resource_Server%EF%BC%89"></span>**èµ„æºæœåŠ¡å™¨ï¼ˆResource Serverï¼‰**<span class="ez-toc-section-end"></span> {.wp-block-heading}

#### <span class="ez-toc-section" id="%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%B1%BB"></span>**èµ„æºæœåŠ¡é…ç½®ç±»**<span class="ez-toc-section-end"></span> {.wp-block-heading}

<pre class="wp-block-preformatted">package com.robin.config;<br /><br />import org.springframework.security.config.annotation.web.builders.HttpSecurity;<br />import org.springframework.security.config.http.SessionCreationPolicy;<br />import org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;<br />import org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;<br />import org.springframework.security.oauth2.provider.token.RemoteTokenServices;<br /><br /><em>/**<br /> * </em><strong><em>@author </em></strong><em>Robin<br /> * </em><strong><em>@date </em></strong><em>2021/4/5<br /> */<br /></em>public class ResourceServerConfiger extends ResourceServerConfigurerAdapter {<br /><br />    private String sign_key = "robin123"; // jwtç­¾åå¯†é’¥<br /><br />    <em>/**<br />     * è¯¥â½…æ³•â½¤äºå®šä¹‰èµ„æºæœåŠ¡å™¨å‘è¿œç¨‹è®¤è¯æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œè¿›â¾tokenæ ¡éªŒç­‰äº‹å®œ<br />     *<br />     * </em><strong><em>@param </em></strong><em>resources<br />     * </em><strong><em>@throws </em></strong><em>Exception<br />     */<br />    </em>@Override<br />    public void configure(ResourceServerSecurityConfigurer resources) throws Exception {<br />        // è®¾ç½®å½“å‰èµ„æºæœåŠ¡çš„èµ„æºid<br />        resources.resourceId("autodeliver");<br />        // å®šä¹‰tokenæœåŠ¡å¯¹è±¡ï¼ˆtokenæ ¡éªŒå°±åº”è¯¥é tokenæœåŠ¡å¯¹è±¡ï¼‰<br />        RemoteTokenServices remoteTokenServices = new RemoteTokenServices();<br />        // æ ¡éªŒç«¯ç‚¹/æ¥â¼è®¾ç½®<br />        remoteTokenServices.setCheckTokenEndpointUrl("http://localhost:9999/oauth/check_token");<br />        // æºå¸¦å®¢æˆ·ç«¯idå’Œå®¢æˆ·ç«¯å®‰å…¨ç <br />        remoteTokenServices.setClientId("client_robin");<br />        remoteTokenServices.setClientSecret("123");<br />        resources.tokenServices(remoteTokenServices);<br />    }<br /><br />    <em>/**<br />     * é€šè¿‡æ­¤æ–¹æ³•è®¾ç½®APIæ¥å£è®¿é—®æƒé™<br />     *<br />     * </em><strong><em>@param </em></strong><em>http<br />     * </em><strong><em>@throws </em></strong><em>Exception<br />     */<br />    </em>@Override<br />    public void configure(HttpSecurity http) throws Exception {<br />        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.<em>IF_REQUIRED</em>) // è®¾ç½®sessionçš„åˆ›å»ºç­–ç•¥ï¼ˆæ­¤å¤„æ˜¯æ ¹æ®éœ€è¦åˆ›å»ºï¼‰<br />                                .and()<br />                                .authorizeRequests()<br />                                // æ­£åˆ™è¡¨è¾¾å¼ï¼Œ/autodeliverå’Œ/demoä¸ºå‰ç¼€çš„é“¾æ¥éœ€è¦è¢«éªŒè¯<br />                                // å…¶ä»–è¯·æ±‚ä¸éªŒè¯<br />                                .antMatchers("/autodeliver/**").authenticated()<br />                                .antMatchers("/demo/**").authenticated()<br />                                .anyRequest().permitAll();<br />    }<br />}<br /></pre>

åç»­è¡¥å……ä½¿â½¤ JWT è¿›â¾æ”¹é€ ï¼Œä½¿â½¤JWTæœºåˆ¶ä¹‹åèµ„æºæœåŠ¡å™¨ä¸éœ€è¦è®¿é—®è®¤è¯æœåŠ¡ã€‚ä½¿ç”¨JWTå°†â½¤æˆ·ä¿¡æ¯å­˜å‚¨åˆ°tokenä¸­ï¼Œè®©å®¢æˆ·ç«¯â¼€ç›´æŒæœ‰è¿™ä¸ªtokenï¼Œä½¿tokençš„éªŒè¯ä¹Ÿåœ¨èµ„æºæœåŠ¡å™¨è¿›â¾ï¼Œè¿™æ ·é¿å…èµ„æºæœåŠ¡å™¨å’Œè®¤è¯æœåŠ¡å™¨é¢‘ç¹çš„äº¤äº’ã€‚

åç»­ä¹Ÿä¼šå°†ç›¸å…³ä»£ç ä¸Šä¼ è‡³Githubã€‚