---
title: ç»å…¸ä¸”ç®€å•çš„ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒç³»ç»Ÿæ¶æ„
date: 2021-07-31T08:29:17+00:00
categories:
  - æ¶æ„
tags:
  - åº”ç”¨æ¶æ„
---
<blockquote class="wp-block-quote">
  <p>
    å„ä½è¯»è€…å¥½ä¹…ä¸è§ï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´çš„å‘¨æœ«éƒ½åœ¨å¿™ç€åœ¨ä¸ºæ–°å·¥ä½œåšå‡†å¤‡ï¼Œæ‰€ä»¥æ²¡æŠŠæ—¶é—´ç”¨åœ¨å†™æ–‡ç« ä¸Šã€‚ä»Šå¤©æœ¬ä¹Ÿæœ‰å®‰æ’ï¼Œ å¯è¿˜æ˜¯æƒ³æŠ½ç‚¹æ—¶é—´å‡ºæ¥å†™ä¸€ç¯‡æ–‡ç« ï¼Œå¯¹è¿™ä¸€é¡¹ç›®çš„æŠ€æœ¯æ ˆåšæ€»ç»“ã€‚
  </p>
</blockquote>

æ–‡ç« æ­£å¼å¼€å§‹ä¹‹å‰è¿˜æ˜¯æƒ³ç®€å•è¯´ä¸€å¥æˆ‘æ‰¾å·¥ä½œçš„æƒ³æ³•ã€‚å—åˆ°å¼€æºç¤¾åŒºä»¥åŠä¸€äº›Youtubeç¨‹åºå‘˜UPä¸»çš„å½±å“ï¼Œå¯¹äºä¸‹ä¸€ä»½å·¥ä½œï¼Œå®ƒåº”è¯¥æ˜¯ä¸€ä»½æˆ‘è‡ªå·±å–œæ¬¢è€Œä¸”æœ‰è‹±è¯­å·¥ä½œç¯å¢ƒçš„å·¥ä½œã€‚å¿«ä¹çš„codingæ‰èƒ½åšå‡ºä¸€ä¸ªçœŸæ­£å—æ¬¢è¿çš„ç¨‹åºå§ ğŸ˜€ è€Œä¸”è‡ªå·±ä¹Ÿä¸ä¼šæ„Ÿè§‰åˆ°å¾ˆç–²æƒ«ã€‚æœŸå¾…æœ‰ä¸€å¤©æˆ‘ä¹Ÿèƒ½æ‹¥æœ‰ä¸€ä¸ªåƒRedisé‚£æ ·å—æ¬¢è¿çš„å¼€æºé¡¹ç›®ã€‚

ä»¥ä¸‹çš„å†…å®¹æ˜¯çœŸå®ä¼ä¸šç”Ÿäº§ç¯å¢ƒçš„é¡¹ç›®æ­å»ºä¸é…ç½®ï¼Œç”±äºé¡¹ç›®é¢å‘çš„äººç¾¤æ¯”è¾ƒç‰¹æ®Šï¼Œå› æ­¤ç³»ç»Ÿçš„ä½¿ç”¨é‡ä¸é«˜ï¼Œå¹¶å‘é‡ä¹Ÿä¸å¤§ï¼Œæ‰€ä»¥æ²¡æœ‰é‡‡ç”¨æ¯”è¾ƒå¤æ‚çš„è®¾è®¡ã€‚é»˜è®¤çš„é…ç½®ä¹Ÿè¾¾åˆ°äº†å‹æµ‹çš„è¦æ±‚ï¼Œæ‰€ä»¥æ²¡æœ‰å¯¹é…ç½®åšè¿‡å¤šçš„ä¼˜åŒ–ã€‚


## <span class="ez-toc-section" id="%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE"></span>ç³»ç»Ÿæ¶æ„å›¾<span class="ez-toc-section-end"></span> {#1.wp-block-heading}

<img decoding="async" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbcb0cde2f8244dc9b8a1cfa03abfe07~tplv-k3u1fbpfcp-watermark.awebp" alt="ç³»çµ±æ¶æ§‹.png" /> ä¸Šå›¾æ˜¯ç³»ç»Ÿæ¶æ„å›¾ï¼Œæ˜¯äº’è”ç½‘å…¬å¸é‡Œæœ€å¸¸è§çš„ç³»ç»Ÿæ¶æ„ã€‚è¿™ç±»ç³»ç»Ÿå¾€å¾€å¤„ç†å¹¶å‘é‡ä¸é«˜ï¼Œè€Œä¸”ä¸šåŠ¡ä¹Ÿä¸å¤æ‚ï¼Œæ‰€ä»¥åšé›†ç¾¤ï¼ˆåŒ…æ‹¬åº”ç”¨ç³»ç»Ÿé›†ç¾¤ï¼ŒRedisé›†ç¾¤ï¼ŒMySQLä¸»ä»ï¼‰çš„ä½œç”¨ä»…æ˜¯ä¿éšœå®ƒçš„é«˜å¯ç”¨ã€‚ç³»ç»Ÿé‡Œé¢æœ‰ä½¿ç”¨åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†è¦æ±‚ä¸é«˜ï¼Œæˆ‘ä»¬å°±ç›´æ¥ç”¨äº†Redisé‡Œçš„listç»“æ„æ¥å®ç°ã€‚ç®€å•çš„äº‹æƒ…ç”¨ç®€å•çš„æ–¹å¼å¤„ç†å³å¯ï¼Œå¯¹äºç®€å•çš„è¦æ±‚å°±æ²¡å¿…è¦ä½¿ç”¨ä¸“ä¸šçš„MQï¼ˆRocketMQ, RabbitMQï¼‰ï¼Œè¦ä¸ç„¶åè€Œå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚

## <span class="ez-toc-section" id="%E6%80%BB%E4%BD%93%E8%AF%B7%E6%B1%82%E6%B5%81%E5%90%91%E5%9B%BE"></span>æ€»ä½“è¯·æ±‚æµå‘å›¾<span class="ez-toc-section-end"></span> {#2.wp-block-heading}

<img decoding="async" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a77e8f24dcf47c1bf490ef5334aa620~tplv-k3u1fbpfcp-watermark.awebp" alt="è¯·æ±‚æµå‘å›¾.png" /> &nbsp;å› ä¸ºé˜¿é‡Œäº‘è·Ÿå®¢æˆ·æœ‰åˆä½œåè®®ï¼Œæ‰€ä»¥æœåŠ¡å™¨èµ„æºéƒ½æ˜¯æ¥è‡ªäºé˜¿é‡Œäº‘ã€‚é€šè¿‡ä¸Šé¢çš„è¯·æ±‚æµå‘å›¾ï¼Œè¯»è€…ä»¬ä¹Ÿå¯ä»¥å¤§è‡´äº†è§£æ•´ä¸ªç³»ç»Ÿçš„ç½‘ç»œæ¶æ„ã€‚

## <span class="ez-toc-section" id="%E8%AF%A6%E7%BB%86%E8%AF%B7%E6%B1%82%E6%B5%81%E5%90%91%E5%9B%BE"></span>è¯¦ç»†è¯·æ±‚æµå‘å›¾<span class="ez-toc-section-end"></span> {#3.wp-block-heading}

<img decoding="async" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4004ced04a9420198dc180ba1c2a4ad~tplv-k3u1fbpfcp-watermark.awebp" alt="è¯¦ç»†è¯·æ±‚æµå‘å›¾.png" /> ä¸Šå›¾ä¸­çš„å¤§çŸ©å½¢æ¡†è¡¨ç¤ºä¸€å°æœåŠ¡å™¨ï¼Œå…¶ä¸­æœ‰è‹¥å¹²çŸ©å½¢æ¡†ä»£è¡¨åŒä¸€å°æœåŠ¡å™¨é‡Œè£…äº†è‹¥å¹²ç»„ä»¶ã€‚æ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯ç»ç”±Nginxå‘å‡ºï¼ŒåŒ…æ‹¬ç”¨æˆ·æµè§ˆHTML/å›¾ç‰‡/å…¶ä»–é™æ€èµ„æºï¼ŒJSè¯·æ±‚æœåŠ¡ç«¯ï¼Œæ‰€ä»¥ä¸Šå›¾çš„Nginxæœ‰ä¸‰ä¸ªå‡ºåº¦ã€‚è¿™é‡Œä½¿ç”¨Rediså“¨å…µæ¨¡å¼è€Œæ²¡æœ‰ä½¿ç”¨é›†ç¾¤æ¨¡å¼ï¼Œä¸»è¦æ˜¯è€ƒè™‘åˆ°æœ¬ç³»ç»Ÿå¯¹Redisçš„ä½¿ç”¨ä»…æ˜¯ä½œä¸ºSessionå…±äº«å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæ¶ˆæ¯çš„æ•°é‡æ¯”è¾ƒå°‘ï¼‰ï¼Œæ€»ä½“çš„æ•°æ®é‡éå¸¸å°‘ï¼Œå°±ä½¿ç”¨ç®€å•ä¸€äº›çš„å“¨å…µæ¨¡å¼ã€‚è€Œæ²¡æœ‰è€ƒè™‘ä½¿ç”¨Redis Clusteræ¨¡å¼ï¼Œå°†æ•°æ®åˆ†æ•£åˆ°ä¸åŒæœåŠ¡å™¨ä¸Šï¼ˆé€šè¿‡slotï¼‰ã€‚Redis Clusteræ¨¡å¼çš„å…¶ä»–èµ„æ–™è¯»è€…å¯è‡ªè¡ŒæŸ¥è¯¢å…¶ä»–èµ„æ–™ã€‚

è¯»è€…é€šè¿‡ä¸Šé¢çš„3å¼ å›¾å¯¹ç³»ç»Ÿæ¡†æ¶æœ‰äº†å¤§æ¦‚çš„äº†è§£åï¼Œä¸‹é¢é™„ä¸Šæ‰€æœ‰ç»„ä»¶çš„æ­å»ºæ­¥éª¤ï¼Œé¡¹ç›®åä¸ºiurcã€‚

## <span class="ez-toc-section" id="%E7%BB%84%E4%BB%B6%E9%83%A8%E7%BD%B2%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4%E4%B8%8E%E9%85%8D%E7%BD%AE"></span>ç»„ä»¶éƒ¨ç½²æ­å»ºæ­¥éª¤ä¸é…ç½®<span class="ez-toc-section-end"></span> {#4.wp-block-heading}

### <span class="ez-toc-section" id="1_%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"></span>1. æœåŠ¡å™¨åŸºç¡€ç¯å¢ƒæ­å»º<span class="ez-toc-section-end"></span> {#4.1.wp-block-heading}

#### <span class="ez-toc-section" id="11_%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%9B%E5%BB%BArobin%E7%94%A8%E6%88%B7"></span>1.1 æ‰€æœ‰æœåŠ¡å™¨åˆ›å»ºrobinç”¨æˆ·<span class="ez-toc-section-end"></span> {#4.1.1.wp-block-heading}

ä¸€å…±æœ‰9å°æœåŠ¡å™¨ï¼Œå‡è®¾IPä¸º`10.210.111.12`&#8211;`10.210.111.20`ã€‚çœŸå®ç¯å¢ƒéœ€è¦é€šè¿‡å ¡å’æœºç™»å…¥ï¼Œè¿™é‡Œå‡è®¾èƒ½ç›´æ¥ç™»å½•æœåŠ¡å™¨ã€‚

é¦–å…ˆä»¥rootç”¨æˆ·é€šè¿‡SSHå·¥å…·ç™»å…¥æœåŠ¡å™¨`10.210.111.12`ï¼Œä½¿ç”¨å‘½ä»¤è¡Œåˆ›å»º`init_server.sh`è„šæœ¬

é¦–å…ˆä»¥rootç”¨æˆ·é€šè¿‡SSHå·¥å…·ç™»å…¥æœåŠ¡å™¨`10.210.111.12`ï¼Œä½¿ç”¨å‘½ä»¤è¡Œåˆ›å»º`init_server.sh`è„šæœ¬

<pre class="wp-block-code"><code class="">vim init_server.sh

# åˆ›å»ºrobinç”¨æˆ·
adduser -m robin
# ä¿®æ”¹ç”¨æˆ·å¯†ç 
passwd robin
# å®‰è£…telent
yum -y install telnet</code></pre>

åˆ›å»º`send_all_servers.sh`è„šæœ¬å°†`init_server.sh`è„šæœ¬åˆ†å‘ç»™æ‰€æœ‰æœåŠ¡å™¨

<pre class="wp-block-code"><code class="">vim send_all_servers.sh

# è„šæœ¬ä¸­å†™å…¥åˆ†å‘å‘½ä»¤ï¼ˆæ­¤æ­¥éª¤çš„ç›®çš„æ˜¯èŠ‚çœåˆ›å»ºç”¨æˆ·çš„æ—¶é—´ï¼Œä½†ä»é¡»ç™»å…¥æ¯ä¸€å°æœåŠ¡å™¨æ‰§è¡Œè¯¥è„šæœ¬ï¼‰
scp $1 root@10.210.111.13:/root/
scp $1 root@10.210.111.14:/root/
scp $1 root@10.210.111.15:/root/
scp $1 root@10.210.111.16:/root/
scp $1 root@10.210.111.17:/root/
scp $1 root@10.210.111.18:/root/
scp $1 root@10.210.111.19:/root/
scp $1 root@10.210.111.20:/root/</code></pre>

æ‰§è¡Œ`send_all_servers.sh`è„šæœ¬ï¼ˆæš‚æœªåšå…å¯†ç™»å½•ï¼Œæ‰§è¡Œè„šæœ¬åéœ€è¦è¾“å…¥ç›®æ ‡æœåŠ¡å™¨å¯†ç ï¼‰

<pre class="wp-block-code"><code class="">chmod +x ./send_all_servers.sh
bash ./send_all_servers.sh ./init_server.sh</code></pre>

åœ¨æ‰€æœ‰æœåŠ¡å™¨æ‰§è¡Œ`init_server.sh`è„šæœ¬

<pre class="wp-block-code"><code class="">chmod +x ./init_server.sh
bash ./init_server.sh</code></pre>

#### <span class="ez-toc-section" id="12_%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%88%E6%9D%83robin%E7%94%A8%E6%88%B7"></span>1.2 æ‰€æœ‰æœåŠ¡å™¨æˆæƒrobinç”¨æˆ·<span class="ez-toc-section-end"></span> {#4.1.2.wp-block-heading}

æ·»åŠ `sudoers`æ–‡ä»¶å¯å¯«æ¬Šé™

<pre class="wp-block-code"><code class="">chmod u+w /etc/sudoers</code></pre>

ä¿®æ”¹`sudoers`æ–‡ä»¶

<pre class="wp-block-code"><code class="">vim /etc/sudoers</code></pre>

åœ¨sudoersæ–‡ä»¶ä¸­æ‰¾åˆ°å¦‚ä¸‹å›¾<figure class="wp-block-image">

<img decoding="async" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/913e4118b58342079cad8aeed3e66bac~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png" /> </figure> 

åœ¨rootè¡Œä¸‹æ–¹æ·»åŠ å¦‚ä¸‹å…§å®¹

<pre class="wp-block-code"><code class="">robin ALL=(ALL) ALL</code></pre>

æ”¶å›`sudoers`æ–‡ä»¶å¯å†™æƒé™

<pre class="wp-block-code"><code class="">chmod u-w /etc/sudoers</code></pre>

âš ï¸ æ‰€æœ‰ECSéƒ½éœ€è¦ç™»å…¥æ‰§è¡Œæˆæƒæ“ä½œ

#### <span class="ez-toc-section" id="13_%E4%BF%AE%E5%A4%8D%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BB%E6%9C%BA%E5%90%8D"></span>1.3 ä¿®å¤æœåŠ¡å™¨ä¸»æœºå<span class="ez-toc-section-end"></span> {#4.1.3.wp-block-heading}

ä¿®æ”¹`10.210.111.12`æœåŠ¡å™¨ä¸»æœºå

<pre class="wp-block-code"><code class="">hostnamectl set-hostname nginx_01
reboot</code></pre>

å»ºè®®ä»¥æ­¤ä¿®æ”¹æ–¹å¼ï¼Œå°†æ‰€æœ‰ä¸»æœºåæ”¹ä¸ºæ­¤æœåŠ¡å™¨ä¸»è¦æä¾›çš„æœåŠ¡ï¼Œåœ¨åç»­æ–¹ä¾¿è¿ç»´ã€‚æˆ‘è®¾ç½®çš„ä¸»æœºåå¦‚ä¸‹ï¼š<figure class="wp-block-table">

| IPåœ°å€          | ç³»çµ±        | ä¸»æœºå      |
| ------------- | --------- | -------- |
| 10.210.111.12 | CentOS7.x | nginx_01 |
| 10.210.111.13 | CentOS7.x | nginx_02 |
| 10.210.111.14 | CentOS7.x | redis_01 |
| 10.210.111.15 | CentOS7.x | redis_02 |
| 10.210.111.16 | CentOS7.x | redis_03 |
| 10.210.111.17 | CentOS7.x | db_01    |
| 10.210.111.18 | CentOS7.x | db_02    |
| 10.210.111.19 | CentOS7.x | app_02   |
| 10.210.111.20 | CentOS7.x | app_02   |</figure> 

### <span class="ez-toc-section" id="2_Nginx%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AE"></span>2. Nginxå®‰è£…åŠé…ç½®<span class="ez-toc-section-end"></span> {#4.2.wp-block-heading}

æœåŠ¡å™¨é…ç½®<figure class="wp-block-table">

| IPåœ°å€          | ç³»ç»Ÿ        | åŠŸèƒ½    |
| ------------- | --------- | ----- |
| 10.210.111.12 | CentOS7.x | Nginx |
| 10.210.111.13 | CentOS7.x | Nginx |</figure> 

#### <span class="ez-toc-section" id="21_%E5%AE%89%E8%A3%85Nginx"></span>2.1 å®‰è£…Nginx<span class="ez-toc-section-end"></span> {#4.2.1.wp-block-heading}

ä½¿ç”¨**SSHå·¥å…·**ä»¥robinç”¨æˆ¶ç™»å…¥æœå‹™å™¨**nginx_01**`10.210.111.12`ï¼Œä¸‹è¼‰Nginxä¸¦è§£å£“ã€‚

<pre class="wp-block-code"><code class="">cd /home/robin
wget http://nginx.org/download/nginx-1.20.1.tar.gz
tar -zxvf nginx-1.20.1.tar.gz && cd nginx-1.20.1</code></pre>

å®‰è£…é¢„ç¼–è¯‘ç¯å¢ƒ

<pre class="wp-block-code"><code class="">sudo yum update
sudo yum -y install gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel</code></pre>

ç¼–è¯‘å®‰è£…ç”¨ä»¥ä¸‹é…ç½®æ›¿æ›`/usr/local/nginx/conf/nginx.conf`è£¡çš„å…§å®¹

<pre class="wp-block-code"><code class="">cd /home/robin/nginx-1.20.1
./configure --prefix=/usr/local/nginx
make
sudo make install</code></pre>

#### <span class="ez-toc-section" id="22_%E9%85%8D%E7%BD%AENginx"></span>2.2 é…ç½®Nginx<span class="ez-toc-section-end"></span> {#4.2.2.wp-block-heading}

ç”¨ä»¥ä¸‹é…ç½®æ›¿æ¢`/usr/local/nginx/conf/nginx.conf`é‡Œçš„å†…å®¹

<pre class="wp-block-code"><code class="">worker_processes  2;

events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  localhost;
        
	location @router{
            rewrite ^.*$ /iurc/index.html break;
        }

        location ^~/iurc {
            root   /usr/local/nginx/html;
            try_files $uri $uri/ @router;
        }

	location ^~/iurc/api {
            proxy_pass http://iurcProxy/iurc/api/channel/http.do;
            proxy_send_timeout 1800;
            proxy_read_timeout 1800;
            proxy_connect_timeout 1800;
            client_max_body_size 2048m;
            proxy_set_header  Host              $http_host;
            proxy_set_header  X-Real-IP   $remote_addr;
            proxy_set_header  X-Real-Port       $remote_port;
            proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
        }

	location @router_admin{
            rewrite ^.*$ /iurc-admin/index.html break;
        }

        location ^~/iurc-admin {
            allow 192.168.10.0/24;
            allow 192.168.12.0/24;
            allow 192.168.30.0/24;
            allow 192.168.160.0/24;
            deny all;
            root   /usr/local/nginx/html;
            try_files $uri $uri/ @router_admin;
        }
	
        location ^~/iurc-admin/api {
            allow 192.168.10.0/24;
            allow 192.168.12.0/24;
            allow 192.168.30.0/24;
            allow 192.168.160.0/24;
            deny all;
            proxy_pass http://iurcAdminProxy/iurc/admin/api/channel/http.do;
            proxy_send_timeout 1800;
            proxy_read_timeout 1800;
            proxy_connect_timeout 1800;
            client_max_body_size 2048m;
            proxy_set_header  Host              $http_host;
            proxy_set_header  X-Real-IP   $remote_addr;
            proxy_set_header  X-Real-Port       $remote_port;
            proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
        }

        location = /50x.html {
            root   html;
        }

    }

    upstream iurcProxy {
        server 10.210.111.19:30068;
        server 10.210.111.20:30068;
    }
    
    upstream iurcAdminProxy {
        server 10.210.111.19:30070;
        server 10.210.111.20:30070;
    }
}</code></pre>

#### <span class="ez-toc-section" id="23_%E5%90%AF%E5%8A%A8Nginx"></span>2.3 å¯åŠ¨Nginx<span class="ez-toc-section-end"></span> {#4.2.3.wp-block-heading}

<pre class="wp-block-code"><code class="">sudo /usr/local/nginx/sbin/nginx</code></pre>

âš ï¸ åœ¨**nginx_02**`10.210.111.13`æœåŠ¡å™¨ä¸ŠæŒ‰ç…§æ­¥éª¤2.1 &#8211; 2.3å®‰è£…é…ç½®Nginx

#### <span class="ez-toc-section" id="24_%E5%88%9B%E5%BB%BAHTML%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95"></span>2.4 åˆ›å»ºHTMLå­˜æ”¾ç›®å½•<span class="ez-toc-section-end"></span> {#4.2.4.wp-block-heading}

<pre class="wp-block-code"><code class="">sudo mkdir /usr/local/nginx/html/iurc
sudo mkdir /usr/local/nginx/html/iurc-admin</code></pre>

è‹¥ä¿®æ”¹äº†`/usr/local/nginx/conf/nginx.conf`é‡Œçš„å†…å®¹ï¼Œå¯ç”¨å¦‚ä¸‹å‘½ä»¤é‡æ–°å¯åŠ¨Nginxï¼Œä½¿æ–°é…ç½®ç”Ÿæ•ˆã€‚

<pre class="wp-block-code"><code class="">sudo /usr/local/nginx/sbin/nginx -s reload</code></pre>

### <span class="ez-toc-section" id="3_Redis%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AE%EF%BC%88%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%EF%BC%89"></span>3. Redisé›†ç¾¤å®‰è£…åŠé…ç½®ï¼ˆå“¨å…µæ¨¡å¼ï¼‰<span class="ez-toc-section-end"></span> {#4.3.wp-block-heading}

æœåŠ¡å™¨é…ç½®<figure class="wp-block-table">

| IPåœ°å€          | ç³»ç»Ÿ        | åŠŸèƒ½        |
| ------------- | --------- | --------- |
| 10.210.111.14 | CentOS7.x | Redis, å“¨å…µ |
| 10.210.111.15 | CentOS7.x | Redis, å“¨å…µ |
| 10.210.111.16 | CentOS7.x | Redis, å“¨å…µ |</figure> 

#### <span class="ez-toc-section" id="31_%E5%AE%89%E8%A3%85Redis"></span>3.1 å®‰è£…Redis<span class="ez-toc-section-end"></span> {#4.3.1.wp-block-heading}

ä»¥robinç”¨æˆ·ç™»å…¥æœåŠ¡å™¨**redis_01**`10.210.111.14`ï¼Œä¸‹è½½Rediså¹¶è§£å‹ã€‚

<pre class="wp-block-code"><code class="">cd /home/robin
wget https://download.redis.io/releases/redis-5.0.9.tar.gz
tar -zxvf redis-5.0.9.tar.gz && cd redis-5.0.9</code></pre>

å®‰è£…é¢„ç¼–è¯‘ç¯å¢ƒåŠå®‰è£…

<pre class="wp-block-code"><code class="">sudo yum update
sudo yum -y install gcc
make
sudo make install PREFIX=/usr/local/redis</code></pre>

âš ï¸ åœ¨**redis_02**`10.210.111.15`æœåŠ¡å™¨ä¸ŠæŒ‰ç…§æ­¥éª¤3.1å®‰è£…é…ç½®Redis

âš ï¸ åœ¨**redis_03**`10.210.111.16`æœåŠ¡å™¨ä¸ŠæŒ‰ç…§æ­¥éª¤3.1å®‰è£…é…ç½®Redis

#### <span class="ez-toc-section" id="32_%E9%85%8D%E7%BD%AERedis"></span>3.2 é…ç½®Redis<span class="ez-toc-section-end"></span> {#4.3.2.wp-block-heading}

åœ¨`10.210.111.14`ä¸­ï¼Œä»redisæºç ç›®å½•ä¸­å¤åˆ¶redis.confè‡³redisçš„å®‰è£…ç›®å½•

<pre class="wp-block-code"><code class="">sudo cp /home/robin/redis-5.0.9/redis.conf /usr/local/redis/bin/ && cd /usr/local/redis/bin/</code></pre>

åœ¨`10.210.111.14`ä¸­ï¼Œä¿®æ”¹redis.confæ–‡ä»¶ï¼š

<pre class="wp-block-code"><code class="">sudo vim redis.conf</code></pre>

å°†`daemonize no`æ”¹ä¸º`daemonize yes`<figure class="wp-block-image">

<img decoding="async" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/448b5af582314f7c85a03853f7a8dfb8~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png" /> </figure> 

æŠŠé»˜è®¤çš„å›ç¯åœ°å€æ³¨é‡Šæ‰ï¼Œé»˜è®¤ä¸èƒ½è¢«å…¶ä»–æœºå™¨è®¿é—®<figure class="wp-block-image">

<img decoding="async" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79354b7c261b44d289622afa382710a6~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png" /> </figure> 

å…³é—­ä¿æŠ¤æ¨¡å¼ï¼Œç”±`yes`æ”¹ä¸º`no`<figure class="wp-block-image">

<img decoding="async" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccd1537f9af7417082cf888466414e2e~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png" /> </figure> 

å°†åœ¨`10.210.111.14`ä¸­ä¿®æ”¹å®Œæˆçš„redis.confæ–‡ä»¶åˆ†å‘åˆ°`10.210.111.15`åŠ`10.210.111.16`ä¸­

<pre class="wp-block-code"><code class="">scp /usr/local/redis/bin/redis.conf root@10.210.111.15:/usr/local/redis/bin/
# æ­¤å¤„ä¼šè¦æ±‚è¾“å…¥10.210.111.15çš„rootå¯†ç 

scp /usr/local/redis/bin/redis.conf root@10.210.111.16:/usr/local/redis/bin/
# æ­¤å¤„ä¼šè¦æ±‚è¾“å…¥10.210.111.16çš„rootå¯†ç </code></pre>

åœ¨`10.210.111.15`ä¸­ï¼Œç¼–è¾‘redis.conf

<pre class="wp-block-code"><code class="">sudo vim /usr/local/redis/bin/redis.conf
#åœ¨æœ€åä¸€è¡ŒåŠ å…¥å¦‚ä¸‹å†…å®¹
replicaof 10.210.111.14 6379</code></pre>

åœ¨`10.210.111.16`ä¸­ï¼Œç¼–è¾‘redis.conf

<pre class="wp-block-code"><code class="">sudo vim /usr/local/redis/bin/redis.conf
#åœ¨æœ€åä¸€è¡ŒåŠ å…¥å¦‚ä¸‹å†…å®¹
replicaof 10.210.111.14 6379</code></pre>

#### <span class="ez-toc-section" id="33_%E9%85%8D%E7%BD%AERedis_Sentinel"></span>3.3 é…ç½®Redis Sentinel<span class="ez-toc-section-end"></span> {#4.3.3.wp-block-heading}

åœ¨`10.210.111.14`ä¸­ï¼Œå®‰è£…redis-sentinel

<pre class="wp-block-code"><code class="">sudo mkdir -p /usr/local/redis-sentinel
sudo cp -r /usr/local/redis/* /usr/local/redis-sentinel</code></pre>

åœ¨`10.210.111.14`ä¸­ï¼Œå¤åˆ¶sentinel.conf

<pre class="wp-block-code"><code class="">sudo cp /home/robin/redis-5.0.9/sentinel.conf /usr/local/redis-sentinel/bin</code></pre>

åœ¨`10.210.111.14`ä¸­ï¼Œä¿®æ”¹sentinel.conf

<pre class="wp-block-code"><code class="">sudo vim /usr/local/redis-sentinel/sentinel.conf

#å°†daemonizeç”±noæ”¹ä¸ºyes
daemonize yes
#æŒ‡å®šå¤šå°‘æ¯«ç§’åï¼Œä¸»èŠ‚ç‚¹æ²¡æœ‰åº”ç­”sentinelã€‚æ­¤æ—¶ï¼Œsentinelä¸»è§‚ä¸Šè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸‹çº¿ï¼Œé»˜è®¤30000æ¯«ç§’ï¼Œæ”¹ä¸º3000æ¯«ç§’
sentinel down-after-milliseconds mymaster 3000</code></pre>

å°†`10.210.111.14`çš„sentinelå¤åˆ¶åˆ°`10.210.111.15`å’Œ`10.210.111.16`ä¸­

<pre class="wp-block-code"><code class="">scp -r /usr/local/redis-sentinel/ root@10.210.111.15:/usr/local
scp -r /usr/local/redis-sentinel/ root@10.210.111.16:/usr/local</code></pre>

åœ¨`10.210.111.15`ä¸­ï¼Œä¿®æ”¹redis.confæ–‡ä»¶

<pre class="wp-block-code"><code class="">vim /usr/local/redis-sentinel/bin/sentinel.conf

# å°†sentinelç›‘æ§çš„redisä¸»èŠ‚ç‚¹ipæ”¹ä¸º10.210.111.14
sentinel monitor mymaster 10.210.111.14 6379 2</code></pre>

åœ¨`10.210.111.16`ä¸­ï¼Œä¿®æ”¹redis.confæ–‡ä»¶

<pre class="wp-block-code"><code class="">sudo vim /usr/local/redis-sentinel/bin/sentinel.conf

# å°†sentinelç›‘æ§çš„redisä¸»èŠ‚ç‚¹ipæ”¹ä¸º10.210.111.14
sentinel monitor mymaster 10.210.111.14 6379 2</code></pre>

#### <span class="ez-toc-section" id="34_%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8Redis%E5%8F%8ARedis_Sentinel"></span>3.4 è®¾ç½®å¼€æœºå¯åŠ¨RedisåŠRedis Sentinel<span class="ez-toc-section-end"></span> {#4.3.4.wp-block-heading}

åœ¨`10.210.111.14`ä¸­ï¼Œ**æ·»åŠ Rediså¼€æœºå¯åŠ¨æœåŠ¡**

<pre class="wp-block-code"><code class="">sudo vim /etc/systemd/system/redis.service

# å¤åˆ¶ç²˜è´´ä»¥ä¸‹å†…å®¹
[Unit]
Description=redis-server
After=network.target

[Service]
Type=forking
ExecStart=/usr/local/redis/bin/redis-server /usr/local/redis/bin/redis.conf
PrivateTmp=true

[Install]
WantedBy=multi-user.target</code></pre>

åœ¨`10.210.111.14`ä¸­ï¼Œ**æ·»åŠ Redis Sentinelå¼€æœºå¯åŠ¨æœåŠ¡**

<pre class="wp-block-code"><code class="">sudo vim /etc/systemd/system/redis-sentinel.service

[Unit]
Description=redis-sentinel
After=network.target

# å¤åˆ¶ç²˜è´´ä»¥ä¸‹å†…å®¹
[Service]
Type=forking
ExecStart=/usr/local/redis-sentinel/bin/redis-sentinel /usr/local/redis-sentinel/bin/sentinel.conf
PrivateTmp=true

[Install]
WantedBy=multi-user.target</code></pre>

é…ç½®è§£é‡Šå¦‚ä¸‹

<pre class="wp-block-code"><code class=""># [Unit]: æœåŠ¡å•å…ƒ
# Description: æè¿°æœåŠ¡
# After: æè¿°æœåŠ¡çš„ç±»åˆ«

# [Serivce]: æœåŠ¡è¿è¡Œå‚æ•°çš„è®¾ç½®
# Type=forking: æ˜¯åå°è¿è¡Œçš„å½¢å¼
# ExecStart: æœåŠ¡çš„å…·ä½“è¿è¡Œå‘½ä»¤
# ExecReload: æœåŠ¡çš„é‡å¯å‘½ä»¤
# ExecStop: æœåŠ¡çš„åœæ­¢å‘½ä»¤
# PrivateTmp=True: è¡¨ç¤ºç»™æœåŠ¡åˆ†é…ç‹¬ç«‹çš„ä¸´æ—¶ç©ºé—´
# âš ï¸ æ³¨æ„ï¼š[Service]çš„å¯åŠ¨ã€é‡å¯ã€åœæ­¢å‘½ä»¤å…¨éƒ¨è¦æ±‚ä½¿ç”¨ç»å¯¹è·¯å¾„

# [Install]: è¿è¡Œçº§åˆ«ä¸‹æœåŠ¡å®‰è£…çš„ç›¸å…³è®¾ç½®ï¼Œå¯è®¾ç½®ä¸ºå¤šç”¨æˆ·ï¼Œå³ç³»ç»Ÿè¿è¡Œçº§åˆ«ä¸º3</code></pre>

âš ï¸ åœ¨`10.210.111.15`å’Œ`10.210.111.16`ä¸­é‡å¤ä»¥ä¸Šè¡¨ç¤º**æ·»åŠ Rediså¼€æœºå¯åŠ¨æœåŠ¡**å’Œ**æ·»åŠ Redis Sentinelå¼€æœºå¯åŠ¨æœåŠ¡**æ­¥éª¤ã€‚

#### <span class="ez-toc-section" id="35_%E5%90%AF%E5%8A%A8Redis%E5%8F%8ARedis_Sentinel"></span>3.5 å¯åŠ¨RedisåŠRedis Sentinel<span class="ez-toc-section-end"></span> {#4.3.5.wp-block-heading}

åœ¨`10.210.111.14`ä¸­ï¼Œ**å¯åŠ¨rediså¹¶åŠ å…¥å¼€æœºè‡ªå¯åŠ¨**

<pre class="wp-block-code"><code class="">sudo systemctl daemon-reload
sudo systemctl start redis.service 
sudo systemctl enable redis.service</code></pre>

åœ¨`10.210.111.14`ä¸­ï¼Œ**å¯åŠ¨Redis sentinelå¹¶åŠ å…¥å¼€æœºè‡ªå¯åŠ¨**

<pre class="wp-block-code"><code class="">sudo systemctl start redis-sentinel.service 
sudo systemctl enable redis-sentinel.service</code></pre>

âš ï¸ åœ¨`10.210.111.15`å’Œ`10.210.111.16`ä¸­é‡å¤ä»¥ä¸Šè¡¨ç¤º**å¯åŠ¨rediså¹¶åŠ å…¥å¼€æœºè‡ªå¯åŠ¨**å’Œ**å¯åŠ¨Redis sentinelå¹¶åŠ å…¥å¼€æœºè‡ªå¯åŠ¨**æ­¥éª¤ã€‚

#### <span class="ez-toc-section" id="36_%E6%B5%8B%E8%AF%95"></span>3.6 æµ‹è¯•<span class="ez-toc-section-end"></span> {#4.3.6.wp-block-heading}

åœ¨ä¸»Redis`10.210.111.14`è¿›å…¥redisæ§åˆ¶å°

<pre class="wp-block-code"><code class="">sudo /usr/local/redis/bin/redis-cli</code></pre>

è¾“å…¥å‘½ä»¤

<pre class="wp-block-code"><code class="">info</code></pre>

è‹¥å‡ºç°ä¸‹å›¾ç»“æœï¼Œè¿æ¥äº†2ä¸ªslavesåˆ™è¡¨ç¤ºRedisä¸»ä»ï¼ˆå“¨å…µæ¨¡å¼ï¼‰å®‰è£…æˆåŠŸ

<img decoding="async" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d2a69a459e074a629cd0d2302113e6bd~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png" /> âš ï¸ è¾“å…¥infoå‘½ä»¤å‡ºæ¥çš„ç»“æœç”±äºç½‘ç»œæˆ–è€…åŒæ­¥çŠ¶æ€çš„æƒ…å†µï¼Œ`connected_slaves`ä¸ä¸€å®šå®æ—¶ä¸º2ï¼Œå¯ä»¥å¤šæŸ¥çœ‹å‡ æ¬¡ã€‚

### <span class="ez-toc-section" id="4_MySQL%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%BB%E4%BB%8E%E6%A8%A1%E5%BC%8F%EF%BC%89"></span>4. MySQLå®‰è£…åŠé…ç½®ï¼ˆä¸»ä»æ¨¡å¼ï¼‰<span class="ez-toc-section-end"></span> {#4.4.wp-block-heading}

æœåŠ¡å™¨é…ç½®<figure class="wp-block-table">

| IPåœ°å€          | ç³»ç»Ÿ        | åŠŸèƒ½   |
| ------------- | --------- | ---- |
| 10.210.111.17 | CentOS7.x | ä¸»æ•¸æ“šåº« |
| 10.210.111.18 | CentOS7.x | å¾æ•¸æ“šåº« |</figure> 

#### <span class="ez-toc-section" id="41_%E5%AE%89%E8%A3%85MySQL"></span>4.1 å®‰è£…MySQL<span class="ez-toc-section-end"></span> {#4.4.1.wp-block-heading}

ä»¥robinç”¨æˆ·ç™»å…¥æœåŠ¡å™¨**db_01**`10.210.111.17`ï¼Œé€šè¿‡YUMæºæ–¹å¼å®‰è£…MySQLã€‚

ä¸‹é¢é“¾æ¥å¾ˆè¯¦ç»†çš„å®˜ç½‘å®‰è£…æ­¥éª¤ï¼Œè¯»è€…ç…§é‡Œé¢è¿™ä¸ªæ­¥éª¤å®‰è£…MySQLå³å¯

<blockquote class="wp-block-quote">
  <p>
    <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Flinux-installation-yum-repo.html" target="_blank" rel="noreferrer noopener">dev.mysql.com/doc/refman/â€¦</a>
  </p>
</blockquote>

#### <span class="ez-toc-section" id="42_%E8%AE%BE%E7%BD%AEMySQL%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5"></span>4.2 è®¾ç½®MySQLè¿œç¨‹è¿æ¥<span class="ez-toc-section-end"></span> {#4.4.2.wp-block-heading}

è®¾ç½®MySQLåªèƒ½ä¸¤ä¸ªAPP SERVER`10.210.111.19`å’Œ`10.210.111.20`è¿æ¥

<pre class="wp-block-code"><code class=""># åœ¨MYSQLå‘½ä»¤è¡Œä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤
GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.210.111.19' IDENTIFIED BY 'P@ssw0rd' WITH GRANT OPTION; 
GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.210.111.20' IDENTIFIED BY 'P@ssw0rd' WITH GRANT OPTION;
GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.210.111.14' IDENTIFIED BY 'P@ssw0rd' WITH GRANT OPTION; 
GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.210.111.15' IDENTIFIED BY 'P@ssw0rd' WITH GRANT OPTION;
FLUSH PRIVILEGES; </code></pre>

âš ï¸ è‡³æ­¤å·²å®Œæˆ`10.210.111.17`çš„MySQLå®‰è£…ï¼Œè¯·ç™»å½•`10.210.111.18`å‚è€ƒ**æ­¥éª¤[4.1 &#8211; 4.2]** åœ¨`10.210.111.18`ä¸Šå®‰è£…MySQLã€‚

#### <span class="ez-toc-section" id="43_%E8%AE%BE%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5"></span>4.3 è®¾ç½®ä¸»ä»åŒæ­¥<span class="ez-toc-section-end"></span> {#4.4.3.wp-block-heading}

âš ï¸ å°†`10.210.111.17`è®¾ç½®ä¸ºä¸»æ•°æ®åº“ï¼Œå°†`10.210.111.18`è®¾ç½®ä¸ºä»æ•°æ®åº“

<pre class="wp-block-code"><code class="">mysql -uroot -p
# è¼¸å…¥å¯†ç¢¼
CREATE USER 'slave'@'%' IDENTIFIED BY 'slaveP@ssw0rd';
GRANT ALL PRIVILEGES ON *.* TO 'slave'@"%" IDENTIFIED BY "slaveP@ssw0rd";</code></pre>

ä¿®æ”¹`10.210.111.17`çš„my.cnfé…ç½®æ–‡ä»¶

<pre class="wp-block-code"><code class="">sudo vim /etc/my.cnf
# åŠ å…¥ä¸¤è¡Œå†…å®¹
log-bin=mysql-bin
server-id=1</code></pre><figure class="wp-block-image">

<img decoding="async" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e64c6106dbdd428397660a636320b067~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png" /> </figure> 

è¯´æ˜

<pre class="wp-block-code"><code class=""># å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—ï¼Œè¯¥æ—¥å¿—æ˜¯åœ¨äº‹åŠ¡æäº¤æ—¶å†™æ—¥å¿—æ–‡ä»¶çš„ã€‚é»˜è®¤å¤§å°æ˜¯1Gï¼Œåé¢åŠ 001,002è¿™æ ·çš„åç¼€é¡ºåŠ ã€‚
log-bin=mysql-bin

# å”¯ä¸€æ ‡è¯†ä¸»æœºï¼Œmysqlä¸»ä»æ¯ä¸ªmysqlå®ä¾‹é…ç½®éƒ½ä¸ä¸€æ ·å°±è¡Œã€‚è¿™ä¸ªå€¼é»˜è®¤æ˜¯0ï¼Œå¦‚æœæ˜¯0ï¼Œä¸»æœåŠ¡å™¨æ‹’ç»ä»»ä½•ä»æœåŠ¡å™¨çš„è¿æ¥ã€‚
server-id=1

# å…¶ä»–é…ç½®ï¼ˆä¸æ˜¯å¿…é¡»é…ç½®çš„ï¼‰ï¼š

# æŒ‡å®šmysqlçš„binlogæ—¥å¿—è®°å½•å“ªä¸ªdbï¼Œé…ç½®éœ€è¦åŒæ­¥çš„æ•°æ®åº“ï¼Œå¯ä»¥é…ç½®å¤šä¸ªï¼Œå¦‚æœæ²¡æœ‰æ­¤é…ç½®é¡¹åˆ™åŒæ­¥å…¨éƒ¨ã€‚
binlog-do-db=db_001ï¼ˆä¸»æ•°æ®åº“é…ç½®ï¼‰

# é…ç½®ä¸åŒæ­¥çš„æ•°æ®åº“ï¼Œå¯ä»¥é…ç½®å¤šä¸ªã€‚
binlog-ignore-db=mysqlï¼ˆä¸»æ•°æ®åº“é…ç½®ï¼‰

# é…ç½®binlogçš„æ ¼å¼
binlog_format=mixed

# é…ç½®æ˜¯å¦åªè¯»  0ä»£è¡¨ä¸åªè¯»ï¼Œ1ä»£è¡¨åªè¯»
read-only=0

# ç”¨äºè®¾å®šåŒä¸»æƒ…å†µä¸‹è‡ªå¢åˆ—çš„IDå†²çªä½¿ç”¨çš„ï¼Œä¸»è¦ç”¨æ¥è®¾ç½®è‡ªå¢æ­¥é•¿
auto-increament-increment=10

# è¡¨ç¤ºè¿™å°æœåŠ¡å™¨çš„åºå·ï¼Œä»1å¼€å§‹ï¼Œä¸è¶…è¿‡auto-increament-increment
auto-increment-offset=1</code></pre>

é‡å¯`10.210.111.17`çš„MySQL

<pre class="wp-block-code"><code class="">sudo systemctl restart mysqld</code></pre>

ä¿®æ”¹`10.210.111.18`çš„my.cnfé…ç½®æ–‡ä»¶

<pre class="wp-block-code"><code class="">sudo vim /etc/my.cnf
# åŠ å…¥ä¸¤è¡Œå†…å®¹
server-id=2
relay_log=mysql-relay-bin</code></pre>

é‡å¯`10.210.111.18`çš„MySQL

<pre class="wp-block-code"><code class="">systemctl restart mysqld.service</code></pre>

è·å– `10.210.111.17`MySQLçš„binlogä¿¡æ¯

<pre class="wp-block-code"><code class="">mysql -uroot -p
# è¾“å…¥å¯†ç 
show master status;</code></pre><figure class="wp-block-image">

<img decoding="async" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/06b99bff95224cb7a51afa18ac1bdad3~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png" /> </figure> 

è¿›å…¥`10.210.111.18`çš„MySQLè®¾ç½®ä¸ä¸»åº“åŒæ­¥

<pre class="wp-block-code"><code class="">mysql -uroot -p
# è¾“å…¥å¯†ç 
change master to master_host='10.210.111.17',master_user='slave',master_password='slaveP@ssw0rd',master_log_file='mysql-bin.000001', master_log_pos=154;</code></pre>

âš ï¸ æ³¨æ„ä»¥ä¸‹è¯´æ˜

<pre class="wp-block-code"><code class="">master_userå’Œmaster_passwordæ˜¯ä¸Šé¢æ­¥éª¤ä¸­åœ¨ä¸»æœåŠ¡å™¨ä¸Šåˆ›å»ºçš„ç”¨æˆ·åâ€œslaveâ€åŠå…¶å¯†ç 

master_log_fileæ˜¯åœ¨ä¸»æœåŠ¡å™¨ä¸ŠæŸ¥è¯¢å‡ºæ¥çš„â€œMySQL binlogä¿¡æ¯â€ä¸­çš„Fileå­—æ®µå€¼ã€‚å¦‚ä¸Šå›¾ä¸­çš„mysql-bin.000001

master_log_posæ˜¯åœ¨ä¸»æœåŠ¡å™¨ä¸ŠæŸ¥è¯¢å‡ºæ¥çš„â€œMySQL binlogä¿¡æ¯â€ä¸­çš„Positionå­—æ®µå€¼ã€‚å¦‚ä¸Šå›¾ä¸­çš„154</code></pre>

å¼€å¯`10.210.111.18`çš„ä»MySQL slaveçº¿ç¨‹

<pre class="wp-block-code"><code class="">start slave;</code></pre>

æŸ¥çœ‹`10.210.111.18`çš„ä»MySQL slaveçŠ¶æ€

<pre class="wp-block-code"><code class="">show slave status \G</code></pre>

<img decoding="async" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccea649225364970a7368b5153ae7ed2~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png" /> çœ‹åˆ°çº¢æ¡†ä¸­ä¸¤ä¸ªYesï¼Œå°±ä»£è¡¨ä»ä»æœåŠ¡å™¨å·²ç»æˆåŠŸä»ä¸»æœåŠ¡å™¨åŒæ­¥æ•°æ®ã€‚

#### <span class="ez-toc-section" id="44_%E4%B8%BB%E4%BB%8E%E9%AA%8C%E8%AF%81"></span>4.4 ä¸»ä»éªŒè¯<span class="ez-toc-section-end"></span> {#4.4.4.wp-block-heading}

åœ¨`10.210.111.17`ä¸»MySQLåŸ·è¡Œå»ºåº«å»ºè¡¨æ“ä½œï¼Œé©—è­‰ä¸»å¾æ¨¡å¼éƒ¨ç½²æˆåŠŸ

<pre class="wp-block-code"><code class="">mysql -uroot -p
# è¾“å…¥å¯†ç 
create database test;
use test;
create table user_test( id int comment'ID',name VARCHAR(20) comment'åç§°', create_time timestamp DEFAULT now() comment'åˆ›å»ºæ—¶é—´' );
insert INTO user_test value(1,"A",NOW());</code></pre>

åœ¨`10.210.111.18`ä»MySQLæŸ¥çœ‹æ˜¯å¦æœ‰åœ¨ä¸»MySQLåˆ›å»ºçš„è¡¨å’Œæ•°æ®

<pre class="wp-block-code"><code class="">mysql -uroot -p
# è¾“å…¥å¯†ç 
show databases;
use test;
show tables;
select * from user_test;</code></pre>

ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ•°æ®å·²ç»ä»ä¸»MySQLåŒæ­¥è‡³ä»MySQLï¼Œè¯æ˜ä¸»ä»æ¨¡å¼å·²ç»éƒ¨ç½²æˆåŠŸã€‚æ¥ä¸‹æ¥åœ¨`10.210.111.17`ä¸»MySQLåˆ é™¤æµ‹è¯•æ•°æ®å³å¯ã€‚

<pre class="wp-block-code"><code class="">drop database test;</code></pre>

### <span class="ez-toc-section" id="5%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%90%8C%E6%AD%A5%E5%AE%89%E8%A3%85"></span>5.é™æ€èµ„æºåŒæ­¥å®‰è£…<span class="ez-toc-section-end"></span> {#4.5.wp-block-heading}

è¿™éƒ¨åˆ†çš„å†…å®¹ä»…ä¾›å‚è€ƒï¼Œå› ä¸ºç°åœ¨çœ‹å›è¿™ä¸ªè®¾è®¡å…¶å®æ˜¯æœ‰äº›é—®é¢˜çš„ã€‚å½“åˆæƒ³é€šè¿‡NginxåšåŠ¨é™åˆ†ç¦»ï¼Œé™æ€æ–‡ä»¶ç›´æ¥é€šè¿‡Nginxè®¿é—®ï¼Œæ–‡ä»¶å¤‡ä»½é€šè¿‡â€œé™æ€èµ„æºåŒæ­¥æœåŠ¡â€ã€‚å¯¹äºå…¬å¼€çš„é™æ€èµ„æºå½“ç„¶æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœç”¨æˆ·ä¸Šä¼ çš„é™æ€èµ„æºæ˜¯ä¸èƒ½å…¬å¼€çš„ï¼Œè¿™é‡Œå°±å­˜åœ¨äº†å¾ˆå¤§çš„é£é™©ï¼Œæ”»å‡»è€…å¾ˆå¯èƒ½é€šè¿‡Nginxç›´æ¥ä¸‹è½½ç”¨æˆ·çš„éšç§èµ„æ–™ã€‚

ç»¼ä¸Šæ‰€è¿°å¾—å‡ºä¸¤æ¡å»ºè®®ï¼š

  * å¯¹äºéšç§æ–‡ä»¶ï¼Œæœ‰æ¡ä»¶çš„è¯å¯ä»¥ä½¿ç”¨OSSæœåŠ¡ã€‚å¦‚æœæ— æ¡ä»¶å¯å‚è€ƒå¦‚ä¸‹çš„é™æ€èµ„æºåŒæ­¥æœåŠ¡ï¼Œæˆ‘è®¤ä¸ºé™¤äº†æˆ‘ä¸‹é¢çš„æœåŠ¡å¤–ï¼Œåº”è¯¥è¿˜ä¼šæœ‰æ›´å¥½çš„é€‰æ‹©ï¼Œè¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥æ‰¾ï¼›
  * å¯¹äºå¯å…¬å¼€çš„é™æ€èµ„æºå¯ä»¥é‡‡ç”¨åŠ¨é™åˆ†ç¦»æ–¹æ¡ˆï¼Œé€šè¿‡Nginxç›´æ¥è·å–ã€‚å¯¹äºéšç§æ–‡ä»¶ï¼Œåˆ‡è®°ä¸å¯é€šè¿‡é…ç½®Nginxç›´æ¥ã€‚

æœåŠ¡å™¨é…ç½®<figure class="wp-block-table">

| IPåœ°å€          | ç³»ç»Ÿ        | åŠŸèƒ½       |
| ------------- | --------- | -------- |
| 10.210.111.13 | CentOS7.x | rsyncæœå‹™ç«¯ |
| 10.210.111.12 | CentOS7.x | rsyncå®¢æˆ¶ç«¯ |</figure> 

#### <span class="ez-toc-section" id="51_rsync%E6%9C%8D%E5%8B%99%E7%AB%AF"></span>5.1 rsyncæœå‹™ç«¯<span class="ez-toc-section-end"></span> {#4.5.1.wp-block-heading}

åœ¨`10.210.111.13`å®‰è£rsync

<pre class="wp-block-code"><code class="">cd /opt
sudo yum install -y rsync</code></pre>

é…ç½®/etc/rsyncd.conf

<pre class="wp-block-code"><code class=""># çºªå½•ä¼ è¾“æ–‡ä»¶æ—¥å¿—
transfer logging = yes
# æŒ‡å®šæ—¥å¿—æ–‡ä»¶
log file = /var/log/rsyncd.log
# pidæ–‡ä»¶è·¯å¾„
pid file = /var/run/rsyncd.pid
# é”è·¯å¾„
lock file = /var/run/rsync.lock
# è¿è¡Œrsyncå®ˆæŠ¤è¿›ç¨‹çš„ç”¨æˆ·
uid = robin
# è¿è¡Œrsyncå®ˆæŠ¤è¿›ç¨‹çš„ç»„
gid = robin
# æ˜¯å¦å…è®¸chrootï¼Œç”¨äºæå‡å®‰å…¨æ€§ã€‚å®¢æˆ·ç«¯è¿æ¥æ¨¡å—ï¼Œé¦–å…ˆchrootåˆ°æ¨¡å—pathå‚æ•°æŒ‡å®šçš„ç›®å½•ä¸‹ï¼Œchrootä¸ºyesæ˜¯å¿…é¡»ä½¿ç”¨rootæƒé™ï¼Œä¸”ä¸èƒ½å¤‡ä»½pathè·¯å¾„å¤–çš„è¿æ¥æ–‡ä»¶
use chroot = yes
# å¿½ç•¥é”™è¯¯
ignore errors
# åªè¯»
read only = no
# è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’
timeout = 60
ignore nonreadable = yes

# æ¨¡å—ï¼Œå¯é…ç½®å¤šä¸ª
[sync_file]
# æ¨¡å—çš„æ ¹ç›®å½•ï¼ŒåŒæ­¥ç›®å½•ï¼Œéœ€è¦æ³¨æ„æƒé™
path = /home/robin/static
# æ¨¡å—è®¤è¯çš„ç”¨æˆ·åç§°ï¼Œå¯ä½¿ç”¨ç©ºæ ¼æˆ–é€—å·éš”å¼€å¤šä¸ªç”¨æˆ·å
auth users = sync
# æ¨¡å—éªŒè¯å¯†ç æ–‡ä»¶ï¼Œå¯æ”¾åœ¨å…¨å±€é…ç½®é‡Œ
secrets file = /etc/rsyncd.secrets
# è®¾å®šç™½åå•ï¼Œå¯æŒ‡å®šIPæ®µï¼ˆ172.18.50.1/255.255.255.0ï¼‰ï¼Œå„IPæ®µç”¨ç©ºæ ¼åˆ†å¼€
hosts allow = 10.210.111.12
hosts deny = *
# æ˜¯å¦å…è®¸åˆ—å‡ºæ¨¡å—å†…å®¹
list = no</code></pre>

æ–°å»º/etc/rsyncd.secretsï¼Œæ­¤å¤„ç”¨robinç”¨æˆ·ä½œä¸ºä½¿ç”¨åŒæ­¥æœåŠ¡çš„ç”¨æˆ·

<pre class="wp-block-code"><code class=""># éœ€è¦ä½¿ç”¨rootè§’è‰²æ‰§è¡Œecho "robin:infoP@ssw0rd" &gt; /etc/rsyncd.secrets
sudo -i
#è¾“å…¥å¯†ç ä½¿ç”¨root
echo "sync:123456" &gt; /etc/rsyncd.secrets
#å†è½¬å›ä½¿ç”¨æ™®é€šç”¨æˆ·
su robin</code></pre>

è®¾ç½®æ–‡ä»¶æƒé™

<pre class="wp-block-code"><code class="">sudo chmod 600 /etc/rsyncd.secrets</code></pre>

å¯åŠ¨æœåŠ¡

<pre class="wp-block-code"><code class="">sudo systemctl restart rsyncd</code></pre>

#### <span class="ez-toc-section" id="52_rsync%E5%AE%A2%E6%88%B6%E7%AB%AF"></span>5.2 rsyncå®¢æˆ¶ç«¯<span class="ez-toc-section-end"></span> {#4.5.2.wp-block-heading}

åœ¨`10.210.111.12`å®‰è£rsync

<pre class="wp-block-code"><code class="">cd /opt
sudo yum install -y rsync</code></pre>

æ–°å»º/etc/rsync.passwdï¼Œå…§å®¹å¦‚ä¸‹ï¼š

<pre class="wp-block-code"><code class=""># éœ€è¦ä½¿ç”¨rootè§’è‰²æ‰§è¡Œecho "infoP@ssw0rd" &gt; /etc/rsync.passwd
sudo -i
#è¾“å…¥å¯†ç ä½¿ç”¨root
echo "123456" &gt; /etc/rsync.passwd
#å†è½¬å›ä½¿ç”¨æ™®é€šç”¨æˆ·
su robin</code></pre>

âš ï¸ å®¢æˆ·ç«¯rsyncåªéœ€è¦å¯†ç ï¼Œæ­¤å¤„å¯†ç å¡«å†™robinç”¨æˆ·çš„å¯†ç 

æ›´æ”¹æƒé™

<pre class="wp-block-code"><code class="">sudo chmod 600 /etc/rsync.passwd</code></pre>

å®‰è£inotify

<blockquote class="wp-block-quote">
  <p>
    inotify-toolså·¥å…·æ£€æµ‹æ–‡ä»¶å¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ã€‚
  </p>
</blockquote>

<pre class="wp-block-code"><code class="">sudo yum install -y inotify-tools</code></pre>

ç¼–å†™å¯åŠ¨è„šæœ¬inotify_start.sh

<pre class="wp-block-code"><code class="">cd /home/robin</code></pre>

è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š

<pre class="wp-block-code"><code class="">#!/bin/bash

Path=/home/robin/static
# æ­¤è™•hostå¡«rsyncæœå‹™å™¨çš„IP
Server=10.210.111.13
User=sync
module=sync_file

/usr/bin/inotifywait -mrq --format '%w%f' -e create,close_write,delete $Path  | while read line  
do
    if [ -f $line ];then
        rsync -az $line --delete ${User}@${Server}::${module} --password-file=/etc/rsync.passwd
    else
        cd $Path &&\
        rsync -az ./ --delete ${User}@${Server}::${module} --password-file=/etc/rsync.passwd
    fi
done</code></pre>

æµ‹è¯•å‘½ä»¤

<pre class="wp-block-code"><code class="">sudo rsync -avz --delete /home/robin/static/ sync@10.210.111.13::sync_file --password-file=/etc/rsync.passwd</code></pre>

#### <span class="ez-toc-section" id="53_%E7%BC%96%E5%86%99%E6%9C%8D%E5%8A%A1%E8%87%AA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"></span>5.3 ç¼–å†™æœåŠ¡è‡ªå¯åŠ¨è„šæœ¬<span class="ez-toc-section-end"></span> {#4.5.3.wp-block-heading}

ç¼–å†™inotifyd.serviceå¹¶å°†å…¶æ‹·è´åˆ°/usr/lib/systemd/system/ç›®å½•ä¸‹ï¼Œå†…å®¹å¦‚ä¸‹

<pre class="wp-block-code"><code class="">[Unit]
Description=inotify rsync script
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
Group=root
PIDFile=/var/run/inotify.pid
ExecStart=/usr/bin/nohup /home/robin/inotify_start.sh &gt; /home/robin/inotify.log 2&gt;&1 &
ExecReload=
ExecStop=/usr/bin/ps -ef | /usr/bin/grep inotify | /usr/bin/grep -v grep | /usr/bin/awk '{print $2}' | /usr/bin/xargs /usr/bin/kill -9
PrivateTmp=true

[Install]
WantedBy=multi-user.target</code></pre>

å¯åŠ¨æœåŠ¡

<pre class="wp-block-code"><code class="">sudo systemctl start inotifyd.service</code></pre>

å…è®¸è‡ªåŠ¨å¯åŠ¨

<pre class="wp-block-code"><code class="">sudo systemctl enable inotifyd.service</code></pre>

é‡æ–°è¯»å–é‡å¯è„šæœ¬

<pre class="wp-block-code"><code class="">sudo systemctl daemon-reload</code></pre>

PSï¼šä»¥ä¸Šæ˜¯æˆ‘åœ¨æ˜é‡‘å†™çš„æ–‡ç« ï¼Œæ‰€ä»¥å›¾ç‰‡å¸¦æ°´å°ã€‚